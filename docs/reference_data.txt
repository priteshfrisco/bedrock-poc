================================================================================
                        REFERENCE DATA DOCUMENTATION
                          Bedrock POC Classification System
                            Last Updated: December 28, 2024
================================================================================

This file documents all reference data files used in the classification system,
including their structure, purpose, and how they are used in the pipeline.

================================================================================
TABLE OF CONTENTS
================================================================================
1. amazon_subcategory_lookup.csv
2. [To be added: ingredient_category_lookup.csv]
3. [To be added: ingredient_health_focus_lookup.csv]
4. [To be added: valid_categories.json]
5. [To be added: valid_attributes.json]


================================================================================
1. AMAZON_SUBCATEGORY_LOOKUP.CSV
================================================================================

FILE LOCATION:
--------------
reference_data/amazon_subcategory_lookup.csv

PURPOSE:
--------
First-stage filtering of Amazon products. Determines which products should be:
- REMOVED (non-supplements like books, equipment, cosmetics)
- REMAPPED (supplements that get assigned to Nature's Way categories)

Used in Step 1 of the pipeline (subcategory filtering).

PIPELINE STAGE:
---------------
Stage 1: Subcategory Filtering
- Runs BEFORE ingredient detection
- Filters out non-supplements to save processing time and LLM costs
- Provides fallback category/subcategory for products where ingredient detection fails

FILE STATISTICS:
----------------
Total entries: 569
- REMOVE actions: 411 (72%)
- REMAP actions: 158 (28%)

Last taxonomy update: December 28, 2024
- Updated 71 REMAP entries from OLD to NEW taxonomy
- 87 REMAP entries already using NEW taxonomy
- Source: NA_Test_for_FI.xlsx (R system reference file)

COLUMN STRUCTURE:
-----------------
Total columns: 9

MAIN COLUMNS (5):
1. amazon_subcategory
   - Type: String
   - Description: Amazon's subcategory name (from product metadata)
   - Source: Amazon/Stackline product data field "amazon_subcategory"
   - Example: "fish oil supplements", "books", "vitamins & supplements"
   - Case: Lowercase
   - Required: Yes

2. action
   - Type: String (enum)
   - Values: "REMOVE" or "REMAP"
   - Description: What to do with products in this Amazon subcategory
   - REMOVE: Filter out (non-supplement products)
   - REMAP: Keep and assign to NW category/subcategory
   - Required: Yes

3. nw_category
   - Type: String
   - Description: Nature's Way category assignment (NEW taxonomy as of 2022)
   - Only populated when action = "REMAP"
   - Empty when action = "REMOVE"
   - Example: "FATTY ACIDS", "BASIC VITAMINS & MINERALS", "HERBAL REMEDIES"
   - Required: Yes (for REMAP), Empty (for REMOVE)

4. nw_subcategory
   - Type: String
   - Description: Nature's Way subcategory assignment (NEW taxonomy as of 2022)
   - Only populated when action = "REMAP"
   - Empty when action = "REMOVE"
   - Example: "FISH", "AMINO ACIDS", "SINGLES"
   - Required: Yes (for REMAP), Empty (for REMOVE)

5. notes
   - Type: String
   - Description: Optional internal notes about the entry
   - Not used by system, for human reference only
   - Required: No

AUDIT TRAIL COLUMNS (4):
Added December 28, 2024 to track taxonomy migration from OLD to NEW

6. old_nw_category
   - Type: String
   - Description: Original category name before 2022 taxonomy update
   - Only populated for entries that were changed
   - Example: "OIL CATEGORY" (changed to "FATTY ACIDS")
   - Empty if entry was already using NEW taxonomy
   - Purpose: Client tracking and audit trail

7. old_nw_subcategory
   - Type: String
   - Description: Original subcategory name before 2022 taxonomy update
   - Only populated for entries that were changed
   - Example: "FISH OIL" (changed to "FISH")
   - Empty if entry was already using NEW taxonomy
   - Purpose: Client tracking and audit trail

8. change_source
   - Type: String
   - Description: Source of the taxonomy update
   - Values:
     * "NA_Test_for_FI.xlsx (2022 Taxonomy Update)" - Changed entries
     * "Original (No change needed)" - Already using NEW taxonomy
     * "REMOVE action" - Non-supplement, no category assigned
   - Purpose: Tracking and documentation

9. change_notes
   - Type: String
   - Description: Detailed explanation of what changed
   - Format: "Updated from OLD: '{old_cat}/{old_subcat}' → NEW: '{new_cat}/{new_subcat}'"
   - Example: "Updated from OLD: 'OIL CATEGORY/FISH OIL' → NEW: 'FATTY ACIDS/FISH'"
   - Purpose: Full audit trail for client review

HOW IT WORKS:
-------------
1. System reads product's "amazon_subcategory" field from input CSV
2. Looks up amazon_subcategory in this file
3. Based on action:
   
   IF action = "REMOVE":
     - Product is filtered out immediately
     - Saved to removed_by_subcategory.csv in audit folder
     - Never sent to LLM for classification
     - Reasoning: "Subcategory filter: '{amazon_subcategory}'"
   
   IF action = "REMAP":
     - Product continues to processing
     - nw_category and nw_subcategory stored as "early assignment"
     - If ingredient detection finds a category: Ingredient category wins
     - If ingredient detection fails: REMAP category used as fallback
   
   IF amazon_subcategory NOT FOUND in file:
     - Product continues to processing (unknown subcategory)
     - Logged in unknown_subcategories.csv for review
     - Relies on ingredient detection for classification

PRIORITY LOGIC (when action = "REMAP"):
----------------------------------------
1. Ingredient detection runs and finds ingredient → USE ingredient category
2. Ingredient detection fails to find ingredient → USE REMAP category (fallback)
3. Both fail → Category = NA (requires manual review)

Example:
  Product: "Nature's Way Fish Oil 1000mg"
  Amazon subcategory: "fish oil supplements"
  
  Step 1: REMAP lookup → Assigns "FATTY ACIDS / FISH" as fallback
  Step 2: Ingredient detection → Finds "fish oil" → Assigns "FATTY ACIDS / FISH"
  Result: Both agree, uses "FATTY ACIDS / FISH" ✓

TAXONOMY MIGRATION (2022 UPDATE):
----------------------------------
In February 2022, company reorganized their entire category taxonomy.
Rather than update all historical data, a mapping layer was created.

OLD Taxonomy (pre-2022):
- OIL CATEGORY → FATTY ACIDS
- PERFORMANCE NUTRITION → ACTIVE NUTRITION
- WEIGHT MANAGEMENT FORMULAS → ACTIVE NUTRITION
- PROTEIN SUPPLEMENTS & MEAL REPLACEMENTS → ACTIVE NUTRITION
- DIGESTIVE AIDS & ENZYMES → PROBIOTICS+
- FIBER PRODUCTS & LAXATIVES → PROBIOTICS+
- PREBIOTICS & PROBIOTICS → PROBIOTICS+
- HERBAL/HOMEOPATHIC COLD & FLU → HERBAL REMEDIES or HOMEOPATHICS
- AMINO ACIDS → BASIC VITAMINS & MINERALS
- COENZYME Q10 → BASIC VITAMINS & MINERALS
- HOMEOPATHIC → HOMEOPATHICS
- GLUCOSAMINE & CHONDROITIN → MISCELLANEOUS SUPPLEMENTS
- FLOWER ESSENCES → HERBAL REMEDIES
- FOOD SUPPLEMENTS → HERBAL REMEDIES

Changes applied December 28, 2024:
- 71 REMAP entries updated to NEW taxonomy
- OLD values preserved in audit columns
- Backup created: amazon_subcategory_lookup_OLD_BACKUP_20241228_220324.csv

NEW CATEGORY DISTRIBUTION (REMAP entries only):
------------------------------------------------
BASIC VITAMINS & MINERALS: 51 entries
HERBAL REMEDIES: 48 entries
ACTIVE NUTRITION: 22 entries
PROBIOTICS+: 11 entries
MISCELLANEOUS SUPPLEMENTS: 8 entries
FATTY ACIDS: 8 entries
COMBINED MULTIVITAMINS: 5 entries
OTC: 3 entries
HOMEOPATHICS: 2 entries

SAMPLE ENTRIES:
---------------

Example 1: REMOVE (non-supplement)
-----------------------------------
amazon_subcategory: books
action: REMOVE
nw_category: (empty)
nw_subcategory: (empty)
notes: (empty)
old_nw_category: (empty)
old_nw_subcategory: (empty)
change_source: REMOVE action
change_notes: Non-supplement - no category mapping needed

Result: All products with amazon_subcategory="books" are filtered out


Example 2: REMAP (supplement, already NEW taxonomy)
----------------------------------------------------
amazon_subcategory: vitamin c supplements
action: REMAP
nw_category: BASIC VITAMINS & MINERALS
nw_subcategory: LETTER VITAMINS
notes: (empty)
old_nw_category: (empty)
old_nw_subcategory: (empty)
change_source: Original (No change needed)
change_notes: Category/Subcategory already using NEW taxonomy

Result: Products can be remapped to BASIC VITAMINS & MINERALS / LETTER VITAMINS


Example 3: REMAP (supplement, updated from OLD taxonomy)
---------------------------------------------------------
amazon_subcategory: fish oil supplements
action: REMAP
nw_category: FATTY ACIDS
nw_subcategory: FISH
notes: (empty)
old_nw_category: OIL CATEGORY
old_nw_subcategory: FISH OIL
change_source: NA_Test_for_FI.xlsx (2022 Taxonomy Update)
change_notes: Updated from OLD: 'OIL CATEGORY/FISH OIL' → NEW: 'FATTY ACIDS/FISH'

Result: Products remapped to FATTY ACIDS / FISH (NEW taxonomy)
Client can see it was changed from OIL CATEGORY / FISH OIL (OLD taxonomy)

MAINTENANCE:
------------
How to add new Amazon subcategories:

1. Run system and check unknown_subcategories.csv in audit folder
2. For each unknown subcategory, determine:
   - Is it a supplement? → action = "REMAP"
   - Is it a non-supplement? → action = "REMOVE"
3. If REMAP, assign appropriate nw_category and nw_subcategory (use NEW taxonomy)
4. Add row to this file
5. Leave old_* columns empty (only populated for migrated entries)
6. Set change_source = "Manual addition [date]"
7. Re-run system

How to update existing entries:

1. Edit nw_category or nw_subcategory as needed
2. Do NOT edit old_* columns (historical record)
3. Update change_notes to document the change
4. Create backup before editing

BACKUP FILES:
-------------
Location: reference_data/backup/amazon_subcategory_lookup_[timestamp].csv
Latest: amazon_subcategory_lookup_OLD_BACKUP_20241228_220324.csv

Before editing this file:
- Create backup in reference_data/backup/ folder
- Use timestamp format: amazon_subcategory_lookup_YYYYMMDD_HHMMSS.csv
- Keep backups for audit trail and rollback capability

SOURCE FILES (R System):
------------------------
This file is derived from:
- NA_Test_for_FI.xlsx (old_r_data/Nature's Way Current Process/...)
  Sheet: "Alternate Coding"
  Columns: Amazon SubCategory, NW Category, NW Subcategory, New NW Category, New NW Subcategory

The R system file had both OLD and NEW taxonomy columns.
We extracted the NEW taxonomy values for our system.

RELATED FILES:
--------------
- ingredient_category_lookup.csv (Stage 2: Ingredient detection)
- non_supplement_keywords.csv (Stage 1b: Title keyword filtering)
- valid_categories.json (Validation: All valid category/subcategory pairs)

IMPACT ON PIPELINE:
-------------------
This file affects:
- Step 1: Subcategory filtering (primary use)
- Cost savings: Removes ~72% of products before expensive LLM calls
- Fallback classification: When ingredient detection fails
- Audit trail: Shows which products were filtered and why

================================================================================
END OF amazon_subcategory_lookup.csv DOCUMENTATION
================================================================================

