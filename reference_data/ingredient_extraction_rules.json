{
  "instructions": "Extract ALL functional ingredients from the product title. For each ingredient found, record its NAME and POSITION (character index in title). This is CRITICAL for determining the primary ingredient.",
  
  "extraction_steps": [
    "1. Scan the entire title for ingredient names",
    "2. For EACH ingredient found, record:",
    "   - ingredient_name: The name of the ingredient (e.g., 'vitamin d', 'turmeric', 'whey protein')",
    "   - position: Character position where ingredient starts in title (0-indexed)",
    "3. Return ALL ingredients found, not just the first one",
    "4. For each ingredient, you MUST call the lookup_ingredient() tool to get its category/subcategory"
  ],
  
  "critical_rules": [
    "DO NOT split compound ingredient names into separate ingredients",
    "Example: 'Vitamin D3' → Extract as ONE ingredient 'vitamin d3' (NOT 'vitamin d' + 'd3')",
    "Example: 'Vitamin B12' → Extract as ONE ingredient 'vitamin b12' (NOT 'vitamin b' + 'b12')",
    "Example: 'Omega-3' → Extract as ONE ingredient 'omega-3' (NOT 'omega' + '3')",
    "IMPORTANT: 'Vitamin D' and 'Vitamin D3' are DIFFERENT ingredients:",
    "  - 'Vitamin D3 5000 IU' → Extract 'vitamin d3' (specific form)",
    "  - 'Vitamin D 5000 IU' → Extract 'vitamin d' (generic)",
    "  - Only extract what's actually in the title - don't add or assume numbers",
    "If you see adjacent words that form a single ingredient name, extract them together"
  ],
  
  "exclusions": {
    "description": "Keywords that should NOT be extracted as functional ingredients. Use context to determine if it's a flavor descriptor vs. real ingredient.",
    "flavor_keywords": ["cherry", "acai", "cranberry", "blueberry", "blackberry", "peppermint", "spearmint", "pumpkin", "vanilla", "chocolate", "strawberry", "orange", "lemon", "lime", "grape", "raspberry"],
    "instructions": [
      "If a word appears to be a FLAVOR descriptor (e.g., 'cherry flavored', 'vanilla taste', 'mint flavor'), DO NOT extract it as an ingredient.",
      "However, if it's clearly a functional ingredient or extract (e.g., 'cherry extract 200mg', 'acai berry extract', 'peppermint oil'), DO extract it.",
      "Context clues for FLAVORS (don't extract): 'flavored', 'flavor', 'taste', 'natural', 'artificial'",
      "Context clues for INGREDIENTS (do extract): 'extract', 'oil', 'powder', 'concentrate', dosage amounts like '200mg'"
    ],
    "examples": [
      {
        "title": "Cherry Flavored Multivitamin 60 Tablets",
        "extract": ["multivitamin"],
        "skip": ["cherry"],
        "reason": "'cherry flavored' indicates taste, not functional ingredient"
      },
      {
        "title": "Acai Berry Extract 500mg Antioxidant 90 Capsules",
        "extract": ["acai"],
        "skip": [],
        "reason": "'acai berry extract 500mg' is a functional ingredient with dosage"
      },
      {
        "title": "Vanilla Protein Shake Mix 2 lbs",
        "extract": ["protein"],
        "skip": ["vanilla"],
        "reason": "'vanilla' describes flavor of the shake, not an ingredient"
      },
      {
        "title": "Cranberry Extract 200mg for Urinary Health 60 Softgels",
        "extract": ["cranberry"],
        "skip": [],
        "reason": "'cranberry extract 200mg' with health claim indicates functional ingredient"
      },
      {
        "title": "Peppermint Oil Capsules 50mg Enteric Coated 60 Count",
        "extract": ["peppermint"],
        "skip": [],
        "reason": "'peppermint oil' with dosage is a functional ingredient"
      }
    ]
  },
  
  "special_cases": {
    "multivitamin": {
      "keywords": ["multivitamin", "multi vitamin", "multi-vitamin", "multiple vitamin"],
      "note": "If detected, this becomes the PRIMARY ingredient regardless of position"
    },
    "protein": {
      "keywords": ["protein", "whey", "isolate", "casein", "pea protein", "soy protein"],
      "note": "Protein ingredients trigger special category override"
    }
  },
  
  "tool_calling": {
    "tool_name": "lookup_ingredient",
    "description": "For EACH ingredient found, call this tool to get category and subcategory from the database",
    "parameters": {
      "ingredient_name": "The name of the ingredient to look up"
    },
    "critical_note": "lookup_ingredient() takes ONLY ingredient_name parameter!",
    "correct_examples": [
      "lookup_ingredient(ingredient_name=\"vitamin d3\")",
      "lookup_ingredient(ingredient_name=\"calcium\")",
      "lookup_ingredient(ingredient_name=\"probiotic\")"
    ],
    "wrong_examples": [
      "lookup_ingredient(ingredient_name=\"vitamin d3\", position=0)  # ❌ WRONG!",
      "lookup_ingredient(name=\"vitamin d3\", position=0)  # ❌ WRONG!",
      "lookup_ingredient(\"vitamin d3\", 0)  # ❌ WRONG!"
    ],
    "note": "You track position internally and include it in your FINAL JSON output, but DO NOT pass position to lookup_ingredient()!",
    "response": {
      "ingredient": "Normalized ingredient name (e.g., 'VITAMIN C (NOT ESTER-C)', 'PROBIOTIC SUPPLEMENT')",
      "nw_category": "Nature's Way category",
      "nw_subcategory": "Nature's Way subcategory",
      "found": "Boolean - whether ingredient was found in database"
    }
  },
  
  "special_handling": {
    "probiotics": {
      "description": "If you extract a specific probiotic strain (akkermansia, lactobacillus, bifidobacterium, etc.) and lookup_ingredient() returns 'found': false, BUT the title contains 'probiotic' or 'probiotics': Use lookup_ingredient(ingredient_name='probiotic') instead to get 'PROBIOTIC SUPPLEMENT'",
      "example": {
        "title": "Akkermansia Probiotic 300 Billion",
        "step_1": "lookup_ingredient(ingredient_name=\"akkermansia\") → returns found: false",
        "step_2": "Title has 'probiotic', so lookup_ingredient(ingredient_name=\"probiotic\") → returns 'PROBIOTIC SUPPLEMENT' ✅"
      }
    },
    "combo_products": {
      "description": "If you see multiple ingredients next to each other (e.g., 'echinacea goldenseal'), try looking up the FULL PHRASE first before splitting",
      "example": {
        "title": "Echinacea Goldenseal Supreme",
        "correct_approach": "lookup_ingredient(ingredient_name=\"echinacea goldenseal\") first → If found, use that result ('ECHINACEA GOLDENSEAL COMBO') → If not found, then split and look up separately",
        "wrong_approach": "Immediately split and look up 'echinacea' and 'goldenseal' separately"
      }
    },
    "normalized_names": {
      "critical_note": "USE THE NORMALIZED NAME FROM LOOKUP RESULTS!",
      "description": "When you call lookup_ingredient('vitamin c'), it returns: {'ingredient': 'VITAMIN C (NOT ESTER-C)', 'nw_category': '...', ...}. You MUST use the 'ingredient' field value in your JSON output.",
      "wrong_example": {
        "name": "vitamin c",
        "note": "This is your raw extraction, DON'T use it!"
      },
      "correct_example": {
        "name": "VITAMIN C (NOT ESTER-C)",
        "note": "Use the 'ingredient' field from lookup!"
      }
    }
  },
  
  "primary_ingredient_logic": {
    "rule": "PRIMARY ingredient is determined by POSITION in title (first found = primary)",
    "exception": "If 'Multiple Vitamin' is detected anywhere, it becomes PRIMARY regardless of position",
    "example": {
      "title": "Vitamin D3 with Calcium and Magnesium 120 Softgels",
      "ingredients_found": [
        {"name": "vitamin d3", "position": 0},
        {"name": "calcium", "position": 18},
        {"name": "magnesium", "position": 30}
      ],
      "primary_ingredient": "vitamin d3 (first by position)",
      "other_ingredients": ["calcium", "magnesium"]
    }
  },
  
  "output_format": {
    "description": "Include 'ingredients' in your final JSON output",
    "example": {
      "ingredients": [
        {
          "name": "VITAMIN D",
          "position": 0,
          "nw_category": "LETTER VITAMINS",
          "nw_subcategory": "VITAMIN D3",
          "found": true
        },
        {
          "name": "CALCIUM",
          "position": 18,
          "nw_category": "MINERALS",
          "nw_subcategory": "CALCIUM",
          "found": true
        }
      ],
      "primary_ingredient": "VITAMIN D"
    },
    "critical_rules": [
      "You MUST set 'primary_ingredient' to the NORMALIZED NAME!",
      "Use the 'ingredient' field from lookup results (e.g., 'VITAMIN D', not 'vitamin d3')",
      "If multivitamin is present → 'primary_ingredient': 'MULTIPLE VITAMIN'",
      "Otherwise → 'primary_ingredient': '[first ingredient by position, NORMALIZED]'",
      "NEVER use your raw extraction - ALWAYS use the normalized name from lookup!",
      "NEVER leave it as 'N/A' or empty!"
    ]
  }
}
