================================================================================
R SYSTEM COMPLETE AUDIT - WHAT WE'RE MISSING
================================================================================
Date: Dec 23, 2025
Purpose: Comprehensive comparison of R system vs our Python LLM system

================================================================================
1. R SYSTEM DATA FILES (Reference Data)
================================================================================

FOUND IN: /old_r_data/Nature's Way Current Process/Amazon Coding Resources - Copy/Data/

✓ hf_lookup.csv                    → We have this (ingredient_health_focus_lookup.csv)
✓ MI Lookup.csv                    → Category/Subcategory/HF translation table
✗ herb_task.xlsx                   → MISSING! 224 herbs, SINGLES vs FORMULAS logic
✗ unique_hf.json                   → MISSING! Used for HF keyword detection
✗ TextReplaceingredient_Final.xlsx → MISSING! Ingredient text replacement rules
✗ NA_Test_for_FI.xlsx              → MISSING! Functional ingredient test data
✗ df_test_form_formDTMOutputForm.csv → MISSING! Form classification training data

================================================================================
2. R SYSTEM MODEL SCRIPTS (Business Logic)
================================================================================

FOUND IN: /old_r_data/.../ModelScripts/

✗ FI_CAT_Testing.R                 → Functional Ingredient + Category classification
✗ HF_JF1.R                         → Health Focus classification
✗ Age Coding Final.R               → Age group classification
✗ Form Coding Final.R              → Form classification
✗ Count Size Coding Final lb update.R → Count/Size extraction
✗ Pack Size Final.R                → Pack size extraction

================================================================================
3. BUSINESS RULES WE IMPLEMENTED
================================================================================

✓ Organic detection (line 337-346)
✓ High Level Category (line 657-673)
✓ Protein overwrites (line 152-180)
✓ Algae overwrites (line 182-215)
✓ SAM-E overwrites (line 176-180)
✓ Weight loss detection (line 217-227)
✓ Multivitamin subcategory logic (line 236-277)
✓ HF lookup merge (line 302-315)
✓ Vitamin D → Bone Health (line 377-381)

================================================================================
4. BUSINESS RULES WE'RE MISSING
================================================================================

❌ HERB SINGLES vs FORMULAS LOGIC (lines herb_task.xlsx)
   - Load 224 herb list
   - Count herbs in product
   - If count > 1 → FORMULAS
   - If count = 1 → SINGLES
   - Exception: YOHIMBE always FORMULAS
   - Skip if subcategory = FOOD SUPPLEMENTS or POLYPHENOLS

❌ UNIQUE HF WORD DETECTION (lines 417-452)
   - Uses unique_hf.json with unique keywords
   - Searches title for these keywords
   - Assigns HF based on first occurrence in title

❌ EXTENSIVE HF OVERWRITES (lines 454-631)
   - 50+ keyword-based HF overwrites in title
   - Examples: COUGH, MELATONIN, TESTOSTERONE, ESTROGEN, etc.
   - Context-aware logic (e.g., ANTIOXIDANT + LIVER = CLEANSE & DETOX)

❌ PROTEIN & MEAL REPLACEMENTS SPLIT (lines 384-393)
   - If form = POWDER → DAILY NUTRITION
   - Else → MEAL REPLACEMENTS

❌ HYDRATION & ELECTROLYTE DETECTION (lines 395-409)
   - HYDRAT (not DEHYDRAT) → ACTIVE NUTRITION - HYDRATION
   - ELECTROLYTE (not CREATINE) → ACTIVE NUTRITION - HYDRATION

❌ COLLAGEN BEAUTY OVERRIDE (lines 589-604)
   - If HF = JOINT HEALTH and COLLAGEN in title
   - Check for BEAUTY, HAIR, SKIN, NAILS
   - Override to BEAUTY

❌ GENDER-BASED HF FIX (lines 633-640)
   - If HF = MEN'S HEALTH and GENDER = FEMALE → WOMEN'S HEALTH
   - If HF = WOMEN'S HEALTH and GENDER = MALE → MEN'S HEALTH

❌ COMBINED MULTI → GENERAL HEALTH (lines 643-650)
   - If Category = COMBINED MULTIVITAMINS → HF = GENERAL HEALTH
   - Else if HF = GENERAL HEALTH → HF = HEALTH FOCUS NON-SPECIFIC

❌ PACK SIZE QC (lines 288-293)
   - If Size > 19 → Move to Count, set Size = 1

❌ MI LOOKUP TRANSFORMATIONS (lines 356-368)
   - Apply Old HF → New HF transformations
   - Apply Old Category/Subcategory → New Category/Subcategory

❌ ECHINACEA GOLDENSEAL COMBO (lines 193-196)
   - Specific ingredient override

❌ CHOLINE AND INOSITOL COMBO (lines 197-200)
   - → MISCELLANEOUS SUPPLEMENTS

❌ CO-ENZYME Q 10 - UBIQUINOL (lines 201-204)
   - → COENZYME Q10

❌ GLANDULAR (lines 205-208)
   - → MISCELLANEOUS SUPPLEMENTS

❌ PROTEIN POWDER TITLE CHECK (lines 209-213)
   - If "PROTEIN POWDER" in title → ACTIVE NUTRITION - PROTEIN & MEAL REPLACEMENTS

================================================================================
5. MASTER OUTPUT COLUMNS (26 TOTAL)
================================================================================

FROM R SYSTEM (line 697-701):
✓ Functional Ingredient
✓ RetailerSku (ASIN)
✓ Age
✓ Count
✓ Unit Of Measurement
✓ Form
✓ Category
✓ Subcategory
✓ Gender
✓ Health Focus
✓ Title
✓ Brand
✓ Size
✓ Organic
✓ High Level Category

FROM USER'S MASTER LIST:
✗ UPC
✗ Description (same as Title?)
✗ NW Category
✗ NW Subcategory
✗ NW Sub Brand 1
✗ NW Sub Brand 2
✗ NW Sub Brand 3
✗ Potency
✗ COMPANY
✗ NW_UPC
✗ Pack Count
✗ Spare1, Spare2, Spare3, Spare4, Spare5

OUR BONUS COLUMNS:
✓ Reasoning
✓ Confidence

================================================================================
6. WHAT LLM IS CURRENTLY EXTRACTING
================================================================================

✓ ingredient (Functional Ingredient)
✓ category
✓ subcategory
✓ form
✓ age
✓ gender
✓ health_focus
✓ confidence
✓ reasoning
✗ count (we asked LLM but need to verify)
✗ size (we asked LLM but need to verify)
✗ unit_of_measurement (we asked LLM but need to verify)
✗ sub_brand_1, sub_brand_2, sub_brand_3 (we asked LLM but need to verify)
✗ potency (we asked LLM but need to verify)
✗ company (we asked LLM but need to verify)
✗ pack_count (we asked LLM but need to verify)

================================================================================
7. WHAT BUSINESS RULES ARE CURRENTLY APPLYING
================================================================================

FROM: src/core/business_rules.py

✓ _apply_organic_status
✓ _apply_high_level_category
✓ _apply_hf_overwrites (uses ingredient_health_focus_lookup.csv)
✓ _apply_protein_overwrites
✓ _apply_algae_overwrites
✓ _apply_sam_e_overwrites
✓ _apply_weight_loss_detection
✓ _apply_multivitamin_subcategories

================================================================================
8. CRITICAL MISSING PIECES
================================================================================

HIGHEST PRIORITY:
1. herb_task.xlsx → HERBAL REMEDIES SINGLES vs FORMULAS logic
2. unique_hf.json → Keyword-based HF detection (50+ rules)
3. MI Lookup.csv transformations → Category/Subcategory/HF remapping
4. Test LLM output for count, size, unit, sub_brand, potency, company, pack_count

MEDIUM PRIORITY:
5. Protein & Meal Replacements split by form
6. Hydration & Electrolyte detection
7. Collagen beauty override
8. Gender-based HF fix
9. Combined Multi → General Health logic
10. Pack size QC (size > 19 → count)
11. Specific ingredient overrides (Echinacea Goldenseal, Choline Inositol, etc.)

LOW PRIORITY:
12. TextReplaceingredient_Final.xlsx → Text normalization rules
13. Separate R model scripts analysis

================================================================================
9. IMMEDIATE ACTION PLAN
================================================================================

STEP 1: CHECK CURRENT LLM OUTPUT
- Run test on 10 products
- Verify if LLM is extracting: count, size, unit, sub_brand, potency, company, pack_count
- Check output quality

STEP 2: ADD MISSING HERB LOGIC
- Extract herb_task.xlsx → herb_list.csv (224 herbs)
- Implement herb counting logic in business_rules.py
- Apply SINGLES vs FORMULAS rule

STEP 3: ADD MISSING HF RULES
- Extract unique_hf.json
- Implement 50+ HF keyword overwrites in business_rules.py
- Add context-aware logic

STEP 4: ADD REMAINING INGREDIENT OVERRIDES
- Echinacea Goldenseal
- Choline Inositol
- CoQ10 Ubiquinol
- Glandular
- Protein Powder title check

STEP 5: ADD FORM-BASED LOGIC
- Protein & Meal Replacements split
- Hydration/Electrolyte detection

STEP 6: ADD FINAL HF FIXES
- Collagen beauty override
- Gender-based HF fix
- Combined Multi → General Health

STEP 7: ADD PACK SIZE QC
- Size > 19 → Count

STEP 8: ADD MI LOOKUP TRANSFORMATIONS
- Apply Old → New mappings

STEP 9: ALIGN OUTPUT COLUMNS
- Match R system's 15 columns exactly
- Add user's master list columns (26 total)
- Keep bonus fields (Reasoning, Confidence)

STEP 10: FULL LOAD TEST
- Test on complete dataset
- Compare output to R system
- Validate accuracy

================================================================================
10. FILES TO EXTRACT FROM R SYSTEM
================================================================================

IMMEDIATE NEED:
1. herb_task.xlsx (Herb List sheet) → reference_data/herb_list.csv
2. unique_hf.json → reference_data/unique_hf.json
3. MI Lookup.csv → reference_data/mi_lookup.csv

OPTIONAL:
4. TextReplaceingredient_Final.xlsx
5. R model scripts for detailed logic review

================================================================================
END OF AUDIT
================================================================================

