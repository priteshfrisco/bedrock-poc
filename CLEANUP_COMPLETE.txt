================================================================================
CLEANUP COMPLETE - READY TO BUILD LLM CLASSIFICATION
================================================================================

Date: December 23, 2025
Status: ✅ CLEAN SLATE

================================================================================
WHAT WAS DELETED
================================================================================

REMOVED OLD CLASSIFICATION CODE:
❌ src/knowledge/ingredient_classifier.py (keyword-based classification)
❌ src/knowledge/attribute_extractor.py (regex extraction)
❌ src/knowledge/llm_classifier.py (old LLM implementation)
❌ src/knowledge/llm_classifier_old.py (backup)
❌ src/knowledge/llm_classifier_clean.py (alternate version)
❌ src/knowledge/classification_validator.py (validation logic)
❌ src/prompts/prompt_builder.py (old prompt builder)
❌ prompts/classification_prompts.json (old prompts)

CLEANED UP PIPELINE:
✅ Removed Step 3 (classification)
✅ Removed Step 4 (assembly)
✅ Pipeline now stops after filtering

================================================================================
WHAT'S LEFT (WORKING COMPONENTS)
================================================================================

✅ src/core/pipeline.py (simplified - stops after filtering)
✅ src/core/preprocessor.py (data cleaning)
✅ src/core/file_logger.py (logging)
✅ src/knowledge/subcategory_filter.py (2-stage filtering)
✅ src/clients/storage_client.py (file I/O)
✅ src/clients/file_tracker.py (processing tracker)

✅ reference_data/amazon_subcategory_lookup.csv (570+ subcategories)
✅ reference_data/non_supplement_keywords.csv (70 keywords)
✅ reference_data/valid_categories.json (categories/subcategories)
✅ reference_data/valid_attributes.json (forms, ages, genders, health focuses)
✅ reference_data/ingredient_category_lookup.json (4,397 ingredient mappings)
✅ reference_data/ingredient_health_focus_lookup.json (202 HF mappings)

================================================================================
CURRENT PIPELINE FLOW
================================================================================

Input: uncoded_amz_p5_2025.csv (31,446 products)
    ↓
STEP 1: PREPROCESSING ✅
    - Standardize columns
    - Clean data
    ↓
STEP 2: FILTERING ✅
    - Subcategory lookup (25,283 removed)
    - Title keywords (390 removed)
    - Total removed: 25,673
    ↓
READY FOR LLM: 5,773 supplements
    ↓
[PIPELINE STOPS HERE]

================================================================================
WHAT NEEDS TO BE BUILT
================================================================================

NEXT: LLM CLASSIFICATION SYSTEM

1. PROMPT DESIGN
   - System message with role definition
   - User prompt template with placeholders
   - Include ALL reference data:
     ✅ Valid categories & subcategories
     ✅ Valid forms (25 types)
     ✅ Valid age groups (7 types)
     ✅ Valid genders (3 types)
     ✅ Valid health focuses (23 types)
     ❌ Ingredient examples (top 100 from 4,397)
     ❌ Ingredient → HF mappings (202 entries)
   
2. LLM CLASSIFIER
   - Support AWS Bedrock (Claude 3 Sonnet)
   - Support OpenAI (for local testing)
   - Batch processing (10 products/call)
   - Parallel processing (multiple batches)
   - Retry logic (3 attempts)
   - Cost tracking
   
3. OUTPUT FORMAT
   - LLM returns ALL fields in JSON:
     {
       "ingredient": "Vitamin D3",
       "category": "BASIC VITAMINS & MINERALS",
       "subcategory": "LETTER VITAMINS",
       "form": "Softgel",
       "age": "AGE GROUP - ADULT",
       "gender": "GENDER - NON SPECIFIC",
       "health_focus": "BONE HEALTH",
       "count": 100,              ← LLM extracts this
       "size": 2000,              ← LLM extracts this
       "unit_of_measurement": "IU", ← LLM extracts this
       "organic": "NOT ORGANIC",
       "high_level_category": "PRIORITY VMS",
       "reasoning": "...",
       "confidence": "high"
     }
   
4. BUSINESS RULES
   - Apply post-LLM business rules from R system
   - Organic overwrites
   - High-level category logic
   - Ingredient-based adjustments

================================================================================
REFERENCE DATA TO INCLUDE IN PROMPT
================================================================================

ALREADY INCLUDED:
✅ Categories (18) + Subcategories (70+)
✅ Forms (25)
✅ Age groups (7)
✅ Genders (3)
✅ Health focuses (23)

NEED TO ADD:
❌ Top 100 ingredient examples:
   "vitamin d" → LETTER VITAMINS → BONE HEALTH
   "calcium" → MINERALS → BONE HEALTH
   "whey protein" → PROTEIN & MEAL REPLACEMENT → ENERGY SUPPORT
   "fish oil" → FISH OIL → CARDIOVASCULAR HEALTH
   "probiotic" → PREBIOTICS & PROBIOTICS → DIGESTIVE HEALTH
   (... 95 more)

WHY: Give LLM concrete examples to match patterns

================================================================================
LLM BENEFITS OVER KEYWORD APPROACH
================================================================================

OLD APPROACH (keyword-based):
  ✓ Fast (no API calls)
  ✓ Free
  ✗ Only matches exact keywords
  ✗ Misses variations ("vit d" vs "vitamin d3")
  ✗ Can't understand context
  ✗ Separate regex for attributes

NEW APPROACH (LLM-based):
  ✓ Understands context ("bone support" → Calcium)
  ✓ Handles variations automatically
  ✓ Extracts attributes in same call
  ✓ Can apply reasoning
  ✓ Returns confidence scores
  ✗ Costs money (~$0.003/1K tokens)
  ✗ Slower (API latency)

SOLUTION: Use LLM for ALL products (5,773) after filtering
  - Cost: ~$5-10 per full run
  - Time: ~2-3 minutes with parallel processing
  - Accuracy: Much higher than keywords

================================================================================
NEXT STEPS
================================================================================

1. ✅ Design prompt with complete context (categories, forms, ingredients)
2. ✅ Build prompt builder to load reference data
3. ✅ Create LLM classifier with AWS Bedrock support
4. ✅ Test on small batch (10 products)
5. ✅ Test on medium batch (100 products)
6. ✅ Run full load (5,773 products)
7. ✅ Add business rules
8. ✅ Final validation

ESTIMATED TIME: 2-3 hours
PRIORITY: High

================================================================================

